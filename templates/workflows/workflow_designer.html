{% extends "base.html" %}
{% load static %}

{% block title %}Hermes - Workflow Designer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.15.6/css/jsplumbtoolkit-defaults.min.css" />
<style>
  .canvas {
    position: relative;
    height: 600px;
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    overflow: auto;
  }
  
  .step {
    position: absolute;
    width: 200px;
    background-color: white;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    padding: 0.5rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    cursor: move;
    z-index: 10;
  }
  
  .step-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }
  
  .step-title {
    font-weight: 600;
    font-size: 0.875rem;
    color: #374151;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
  }
  
  .step-body {
    font-size: 0.75rem;
    color: #6b7280;
  }
  
  .step-footer {
    display: flex;
    justify-content: space-between;
    margin-top: 0.5rem;
    font-size: 0.75rem;
  }
  
  .action-badge {
    font-size: 0.625rem;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
  }
  
  .endpoint {
    width: 10px;
    height: 10px;
    background-color: #6b7280;
    cursor: pointer;
  }
  
  .source-endpoint {
    position: absolute;
    bottom: -5px;
    left: 50%;
    transform: translateX(-50%);
  }
  
  .target-endpoint {
    position: absolute;
    top: -5px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 20;
  }
  
  /* Make endpoints more visible when hovering over steps */
  .step:hover .source-endpoint,
  .step:hover .target-endpoint,
  .conditional-junction:hover .conditional-endpoint {
    background-color: #3b82f6;  /* blue-500 */
    width: 12px;
    height: 12px;
    border: 2px solid white;
  }
  
  .actions-panel {
    height: 600px;
    overflow-y: auto;
    background-color: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
  }
  
  .action-item {
    cursor: grab;
    padding: 0.5rem;
    margin-bottom: 0.25rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.25rem;
    transition: all 0.2s;
  }
  
  .action-item:hover {
    background-color: #f3f4f6;
  }
  
  .conditional-junction {
    width: 40px;
    height: 40px;
    background-color: #f59e0b;
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    cursor: move;
    position: absolute;
    z-index: 10;
  }
  
  .conditional-endpoint {
    width: 8px;
    height: 8px;
    background-color: #6b7280;
    position: absolute;
    cursor: pointer;
  }
  
  .true-endpoint {
    right: -4px;
    top: 50%;
    transform: translateY(-50%);
  }
  
  .false-endpoint {
    bottom: -4px;
    left: 50%;
    transform: translateX(-50%);
  }
  
  .condition-dialog {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }
  
  .condition-dialog-content {
    background-color: white;
    padding: 1.5rem;
    border-radius: 0.5rem;
    width: 500px;
    max-width: 90%;
  }
  
  .delete-button {
    color: #ef4444;
    cursor: pointer;
  }
  
  .edit-button {
    color: #3b82f6;
    cursor: pointer;
    margin-right: 0.5rem;
  }
</style>
{% endblock %}

{% block page_header %}
<div class="md:flex md:items-center md:justify-between">
  <div class="flex-1 min-w-0">
    <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
      {% if workflow.pk %}Edit Workflow: {{ workflow.name }}{% else %}Create New Workflow{% endif %}
    </h2>
  </div>
  <div class="mt-4 flex md:mt-0 md:ml-4">
    <a href="{% url 'workflows:index' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
      Back to Workflows
    </a>
    <button id="saveWorkflowBtn" class="ml-3 inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
      Save Workflow
    </button>
  </div>

  <!-- Hidden form for AJAX compatibility -->
  <form id="workflowForm" style="display: none;" method="post" action="">
    {% csrf_token %}
    <input type="hidden" name="name" id="hiddenWorkflowName">
    <input type="hidden" name="description" id="hiddenWorkflowDescription">
    <input type="hidden" name="is_active" value="true">
    <input type="hidden" name="workflow_data" id="hiddenWorkflowData">
  </form>
</div>
{% endblock %}

{% block content %}
<div class="mb-5">
  <div class="grid grid-cols-1 gap-4 lg:grid-cols-2">
    <div>
      <label for="workflowName" class="block text-sm font-medium text-gray-700">Workflow Name</label>
      <input type="text" name="workflowName" id="workflowName" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" value="{{ workflow.name|default:'' }}">
    </div>
    <div>
      <label for="workflowDescription" class="block text-sm font-medium text-gray-700">Description</label>
      <input type="text" name="workflowDescription" id="workflowDescription" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" value="{{ workflow.description|default:'' }}">
    </div>
  </div>
</div>

<div class="grid grid-cols-12 gap-4">
  <!-- Actions Panel -->
  <div class="col-span-12 md:col-span-3">
    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
      <div class="px-4 py-5 sm:px-6 bg-gray-50">
        <h3 class="text-lg leading-6 font-medium text-gray-900">
          Available Actions
        </h3>
        <p class="mt-1 max-w-2xl text-sm text-gray-500">
          Drag and drop to add to workflow
        </p>
      </div>
      <div class="actions-panel p-4">
        <div class="mb-4">
          <h4 class="font-medium text-sm text-gray-700 mb-2">Flow Controls</h4>
          <div class="action-item flow-control" data-type="start">
            <div class="flex items-center">
              <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-green-100 text-green-800 mr-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                </svg>
              </span>
              <span class="font-medium text-sm">Start</span>
            </div>
          </div>
          <div class="action-item flow-control" data-type="conditional">
            <div class="flex items-center">
              <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-yellow-100 text-yellow-800 mr-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
              </span>
              <span class="font-medium text-sm">Conditional</span>
            </div>
          </div>
          <div class="action-item flow-control" data-type="end">
            <div class="flex items-center">
              <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-red-100 text-red-800 mr-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" />
                </svg>
              </span>
              <span class="font-medium text-sm">End</span>
            </div>
          </div>
        </div>
        
        <h4 class="font-medium text-sm text-gray-700 mb-2">Database Actions</h4>
        {% for action in database_actions %}
        <div class="action-item" data-type="action" data-id="{{ action.id }}" data-name="{{ action.name }}" data-action-type="{{ action.action_type }}">
          <div class="flex items-center">
            <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-indigo-100 text-indigo-800 mr-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M3 12v3c0 1.657 3.134 3 7 3s7-1.343 7-3v-3c0 1.657-3.134 3-7 3s-7-1.343-7-3z" />
                <path d="M3 7v3c0 1.657 3.134 3 7 3s7-1.343 7-3V7c0 1.657-3.134 3-7 3S3 8.657 3 7z" />
                <path d="M17 5c0 1.657-3.134 3-7 3S3 6.657 3 5s3.134-3 7-3 7 1.343 7 3z" />
              </svg>
            </span>
            <span class="font-medium text-sm">{{ action.name }}</span>
          </div>
        </div>
        {% endfor %}
        
        <h4 class="font-medium text-sm text-gray-700 mb-2 mt-4">Data Source Actions</h4>
        {% for action in datasource_actions %}
        <div class="action-item" data-type="action" data-id="{{ action.id }}" data-name="{{ action.name }}" data-action-type="{{ action.action_type }}">
          <div class="flex items-center">
            <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-blue-100 text-blue-800 mr-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            </span>
            <span class="font-medium text-sm">{{ action.name }}</span>
          </div>
        </div>
        {% endfor %}
        
        <h4 class="font-medium text-sm text-gray-700 mb-2 mt-4">File Actions</h4>
        {% for action in file_actions %}
        <div class="action-item" data-type="action" data-id="{{ action.id }}" data-name="{{ action.name }}" data-action-type="{{ action.action_type }}">
          <div class="flex items-center">
            <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-purple-100 text-purple-800 mr-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
              </svg>
            </span>
            <span class="font-medium text-sm">{{ action.name }}</span>
          </div>
        </div>
        {% endfor %}
        
        <h4 class="font-medium text-sm text-gray-700 mb-2 mt-4">Other Actions</h4>
        {% for action in other_actions %}
        <div class="action-item" data-type="action" data-id="{{ action.id }}" data-name="{{ action.name }}" data-action-type="{{ action.action_type }}">
          <div class="flex items-center">
            <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-gray-100 text-gray-800 mr-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
              </svg>
            </span>
            <span class="font-medium text-sm">{{ action.name }}</span>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  
  <!-- Canvas -->
  <div class="col-span-12 md:col-span-9">
    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
      <div class="px-4 py-5 sm:px-6 bg-gray-50 flex justify-between items-center">
        <div>
          <h3 class="text-lg leading-6 font-medium text-gray-900">
            Workflow Design
          </h3>
          <p class="mt-1 max-w-2xl text-sm text-gray-500">
            Drag actions to position, connect with arrows, double-click to edit
          </p>
        </div>
        <div>
          <button id="clearCanvasBtn" class="text-sm font-medium text-red-600 hover:text-red-500">
            Clear Canvas
          </button>
        </div>
      </div>
      <div class="canvas" id="workflowCanvas">
        <!-- Connection Help Tooltip -->
        <div class="connection-help">
          <div class="connection-help-title">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
            </svg>
            How to Connect Steps
          </div>
          <p>Drag from one node's endpoint to another to create connections:</p>
          <ul>
            <li>Look for the <b>dots</b> at the top and bottom of steps</li>
            <li>Drag from a <b>bottom dot</b> to a <b>top dot</b> of another step</li>
            <li>For conditionals, connect the <b>True</b> (right) and <b>False</b> (bottom) paths</li>
            <li>Double-click steps to edit their properties</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Conditional Dialog -->
<div id="conditionDialog" class="condition-dialog">
  <div class="condition-dialog-content">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-medium text-gray-900">Edit Condition</h3>
      <button type="button" class="condition-dialog-close text-gray-400 hover:text-gray-500">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <div class="mb-4">
      <label for="conditionExpression" class="block text-sm font-medium text-gray-700">Condition Expression</label>
      <textarea id="conditionExpression" rows="3" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"></textarea>
      <p class="mt-2 text-sm text-gray-500">
        Use Python-like syntax, e.g. <code>result['count'] > 10</code> or <code>data['status'] == 'active'</code>
      </p>
    </div>
    
    <div class="flex justify-end">
      <button type="button" class="condition-dialog-close bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        Cancel
      </button>
      <button type="button" id="saveConditionBtn" class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        Save
      </button>
    </div>
  </div>
</div>

<!-- Step Dialog -->
<div id="stepDialog" class="condition-dialog">
  <div class="condition-dialog-content">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-medium text-gray-900">Edit Step</h3>
      <button type="button" class="step-dialog-close text-gray-400 hover:text-gray-500">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <div class="mb-4">
      <label for="stepParameters" class="block text-sm font-medium text-gray-700">Step Parameters (JSON)</label>
      <textarea id="stepParameters" rows="5" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md font-mono"></textarea>
    </div>
    
    <div class="flex justify-end">
      <button type="button" class="step-dialog-close bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        Cancel
      </button>
      <button type="button" id="saveStepBtn" class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        Save
      </button>
    </div>
  </div>
</div>

<!-- Workflow data -->
<input type="hidden" id="workflowData" value="{{ workflow_data|default:'{}' }}">
<input type="hidden" id="csrfToken" value="{{ csrf_token }}">
<input type="hidden" id="workflowId" value="{{ workflow.id|default:'' }}">
<input type="hidden" id="saveUrl" value="{% if workflow.pk %}{% url 'workflows:designer_edit' workflow.pk %}{% else %}{% url 'workflows:designer' %}{% endif %}">
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.15.6/js/jsplumb.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const workflowCanvas = document.getElementById('workflowCanvas');
  const clearCanvasBtn = document.getElementById('clearCanvasBtn');
  const saveWorkflowBtn = document.getElementById('saveWorkflowBtn');
  const conditionDialog = document.getElementById('conditionDialog');
  const stepDialog = document.getElementById('stepDialog');
  const saveConditionBtn = document.getElementById('saveConditionBtn');
  const saveStepBtn = document.getElementById('saveStepBtn');
  const conditionExpression = document.getElementById('conditionExpression');
  const stepParameters = document.getElementById('stepParameters');
  
  let currentStepId = null;
  let currentWorkflow = {};
  
  // Initialize jsPlumb with more visible endpoints and better connection styling
  const jsPlumbInstance = jsPlumb.getInstance({
    // Endpoint appearance
    Endpoint: ["Dot", { 
      radius: 4,
      cssClass: "endpoint",
      hoverClass: "endpoint-hover" 
    }],
    
    // Connection style
    Connector: ["Flowchart", { 
      cornerRadius: 5,
      stub: 20,
      gap: 8 
    }],
    
    // Default connection appearance
    PaintStyle: { 
      stroke: "#6b7280", 
      strokeWidth: 2
    },
    
    // Hover style for connections
    HoverPaintStyle: { 
      stroke: "#1d4ed8", 
      strokeWidth: 3 
    },
    
    // Arrow at the end of connections
    ConnectionOverlays: [
      ["Arrow", { 
        location: 1, 
        width: 12, 
        length: 12, 
        foldback: 0.8,
        id: "arrow" 
      }]
    ],
    
    // Make new connections appear on top
    DragOptions: { 
      zIndex: 2000 
    },
    
    // Container for the canvas
    Container: workflowCanvas
  });
  
  // Load existing workflow data if available
  try {
    const workflowDataInput = document.getElementById('workflowData');
    if (workflowDataInput.value) {
      currentWorkflow = JSON.parse(workflowDataInput.value);
      loadWorkflow(currentWorkflow);
    }
  } catch (e) {
    console.error('Failed to load workflow data:', e);
  }
  
  // Make action items draggable
  document.querySelectorAll('.action-item').forEach(item => {
    item.addEventListener('dragstart', function(e) {
      e.dataTransfer.setData('text/plain', JSON.stringify({
        type: this.getAttribute('data-type'),
        id: this.getAttribute('data-id'),
        name: this.getAttribute('data-name'),
        actionType: this.getAttribute('data-action-type')
      }));
    });
    
    item.setAttribute('draggable', 'true');
  });
  
  // Set up canvas drop handling
  workflowCanvas.addEventListener('dragover', function(e) {
    e.preventDefault();
  });
  
  workflowCanvas.addEventListener('drop', function(e) {
    e.preventDefault();
    
    try {
      const data = JSON.parse(e.dataTransfer.getData('text/plain'));
      const canvasRect = workflowCanvas.getBoundingClientRect();
      
      let left = e.clientX - canvasRect.left;
      let top = e.clientY - canvasRect.top;
      
      if (data.type === 'action') {
        addActionToCanvas(data, left, top);
      } else if (data.type === 'start') {
        addStartNodeToCanvas(left, top);
      } else if (data.type === 'end') {
        addEndNodeToCanvas(left, top);
      } else if (data.type === 'conditional') {
        addConditionalToCanvas(left, top);
      }
    } catch (e) {
      console.error('Error handling drop:', e);
    }
  });
  
  // Function to add action step to canvas
  function addActionToCanvas(data, left, top) {
    const stepId = 'step_' + Date.now();
    const step = document.createElement('div');
    step.className = 'step';
    step.id = stepId;
    step.setAttribute('data-type', 'action');
    step.setAttribute('data-action-id', data.id);
    step.setAttribute('data-parameters', '{}');
    
    let badgeClass = 'bg-gray-100 text-gray-800';
    if (data.actionType === 'database_query') {
      badgeClass = 'bg-indigo-100 text-indigo-800';
    } else if (data.actionType === 'datasource_refresh') {
      badgeClass = 'bg-blue-100 text-blue-800';
    } else if (data.actionType === 'file_create') {
      badgeClass = 'bg-purple-100 text-purple-800';
    }
    
    step.innerHTML = `
      <div class="step-header">
        <div class="step-title">${data.name}</div>
        <div class="flex">
          <span class="edit-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          </span>
          <span class="delete-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </span>
        </div>
      </div>
      <div class="step-body">
        ${data.actionType} action
      </div>
      <div class="step-footer">
        <span class="action-badge ${badgeClass}">${data.actionType}</span>
      </div>
      <div class="source-endpoint"></div>
      <div class="target-endpoint"></div>
    `;
    
    step.style.left = left + 'px';
    step.style.top = top + 'px';
    
    workflowCanvas.appendChild(step);
    
    // Make step draggable
    jsPlumbInstance.draggable(stepId, {
      grid: [10, 10]
    });
    
    // Add endpoint for sources (where connections start from)
    jsPlumbInstance.addEndpoint(stepId, {
      anchor: "Bottom",
      isSource: true,
      maxConnections: -1,
      cssClass: 'source-endpoint',
      connectorStyle: { stroke: "#6b7280", strokeWidth: 2 },
      connectorHoverStyle: { stroke: "#1d4ed8", strokeWidth: 3 },
      connectionType: "basic",
      endpoint: ["Dot", { radius: 5 }],
      paintStyle: { fill: "#6b7280", stroke: "#ffffff", strokeWidth: 2 },
      hoverPaintStyle: { fill: "#3b82f6", stroke: "#ffffff", strokeWidth: 2 },
      connectorOverlays: [
        ["Arrow", { location: 1, width: 12, length: 12, foldback: 0.8 }]
      ]
    });
    
    // Add endpoint for targets (where connections end at)
    jsPlumbInstance.addEndpoint(stepId, {
      anchor: "Top",
      isTarget: true,
      maxConnections: -1,
      cssClass: 'target-endpoint',
      endpoint: ["Dot", { radius: 5 }],
      paintStyle: { fill: "#6b7280", stroke: "#ffffff", strokeWidth: 2 },
      hoverPaintStyle: { fill: "#3b82f6", stroke: "#ffffff", strokeWidth: 2 }
    });
    
    // Add event listeners
    step.querySelector('.delete-button').addEventListener('click', function() {
      deleteStep(stepId);
    });
    
    step.querySelector('.edit-button').addEventListener('click', function() {
      editStepParameters(stepId);
    });
    
    // Double-click to edit
    step.addEventListener('dblclick', function() {
      editStepParameters(stepId);
    });
    
    // Add to workflow data
    currentWorkflow[stepId] = {
      type: 'action',
      actionId: data.id,
      actionName: data.name,
      actionType: data.actionType,
      parameters: {},
      position: { left, top }
    };
  }
  
  // Function to add start node to canvas
  function addStartNodeToCanvas(left, top) {
    const stepId = 'start_' + Date.now();
    const step = document.createElement('div');
    step.className = 'step';
    step.id = stepId;
    step.setAttribute('data-type', 'start');
    
    step.innerHTML = `
      <div class="step-header">
        <div class="step-title">Start</div>
        <div class="flex">
          <span class="delete-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </span>
        </div>
      </div>
      <div class="step-body">
        Workflow starting point
      </div>
      <div class="step-footer">
        <span class="action-badge bg-green-100 text-green-800">start</span>
      </div>
      <div class="source-endpoint"></div>
    `;
    
    step.style.left = left + 'px';
    step.style.top = top + 'px';
    
    workflowCanvas.appendChild(step);
    
    // Make step draggable
    jsPlumbInstance.draggable(stepId, {
      grid: [10, 10]
    });
    
    // Add source endpoint only
    jsPlumbInstance.addEndpoint(stepId, {
      anchor: "Bottom",
      isSource: true,
      maxConnections: -1,
      cssClass: 'source-endpoint'
    });
    
    // Add event listeners
    step.querySelector('.delete-button').addEventListener('click', function() {
      deleteStep(stepId);
    });
    
    // Add to workflow data
    currentWorkflow[stepId] = {
      type: 'start',
      position: { left, top }
    };
  }
  
  // Function to add end node to canvas
  function addEndNodeToCanvas(left, top) {
    const stepId = 'end_' + Date.now();
    const step = document.createElement('div');
    step.className = 'step';
    step.id = stepId;
    step.setAttribute('data-type', 'end');
    
    step.innerHTML = `
      <div class="step-header">
        <div class="step-title">End</div>
        <div class="flex">
          <span class="delete-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </span>
        </div>
      </div>
      <div class="step-body">
        Workflow ending point
      </div>
      <div class="step-footer">
        <span class="action-badge bg-red-100 text-red-800">end</span>
      </div>
      <div class="target-endpoint"></div>
    `;
    
    step.style.left = left + 'px';
    step.style.top = top + 'px';
    
    workflowCanvas.appendChild(step);
    
    // Make step draggable
    jsPlumbInstance.draggable(stepId, {
      grid: [10, 10]
    });
    
    // Add target endpoint only
    jsPlumbInstance.addEndpoint(stepId, {
      anchor: "Top",
      isTarget: true,
      maxConnections: -1,
      cssClass: 'target-endpoint'
    });
    
    // Add event listeners
    step.querySelector('.delete-button').addEventListener('click', function() {
      deleteStep(stepId);
    });
    
    // Add to workflow data
    currentWorkflow[stepId] = {
      type: 'end',
      position: { left, top }
    };
  }
  
  // Function to add conditional junction to canvas
  function addConditionalToCanvas(left, top) {
    const condId = 'cond_' + Date.now();
    const conditional = document.createElement('div');
    conditional.className = 'conditional-junction';
    conditional.id = condId;
    conditional.setAttribute('data-type', 'conditional');
    conditional.setAttribute('data-condition', '');
    
    conditional.innerHTML = `
      <span>?</span>
      <div class="conditional-endpoint target-endpoint"></div>
      <div class="conditional-endpoint true-endpoint" data-condition-path="true"></div>
      <div class="conditional-endpoint false-endpoint" data-condition-path="false"></div>
    `;
    
    conditional.style.left = left + 'px';
    conditional.style.top = top + 'px';
    
    workflowCanvas.appendChild(conditional);
    
    // Make conditional draggable
    jsPlumbInstance.draggable(condId, {
      grid: [10, 10]
    });
    
    // Add target endpoint (where connection comes in)
    jsPlumbInstance.addEndpoint(condId, {
      anchor: "Top",
      isTarget: true,
      maxConnections: -1,
      cssClass: 'target-endpoint',
      endpoint: ["Dot", { radius: 5 }],
      paintStyle: { fill: "#6b7280", stroke: "#ffffff", strokeWidth: 2 },
      hoverPaintStyle: { fill: "#3b82f6", stroke: "#ffffff", strokeWidth: 2 }
    });
    
    // Add "True" path endpoint
    jsPlumbInstance.addEndpoint(condId, {
      anchor: "Right",
      isSource: true,
      maxConnections: 1,
      cssClass: 'true-endpoint',
      parameters: {
        conditionPath: 'true'
      },
      connectorStyle: { stroke: "#059669", strokeWidth: 2 }, // Green for true
      connectorHoverStyle: { stroke: "#047857", strokeWidth: 3 },
      endpoint: ["Dot", { radius: 5 }],
      paintStyle: { fill: "#059669", stroke: "#ffffff", strokeWidth: 2 },
      hoverPaintStyle: { fill: "#047857", stroke: "#ffffff", strokeWidth: 2 },
      connectorOverlays: [
        ["Arrow", { location: 1, width: 12, length: 12, foldback: 0.8 }],
        ["Label", { 
          label: "True", 
          location: 0.5, 
          cssClass: "connection-label",
          labelStyle: { 
            color: "#059669",
            font: "12px sans-serif",
            padding: "2px 4px",
            backgroundColor: "#ecfdf5",
            borderRadius: "3px"
          }
        }]
      ]
    });
    
    // Add "False" path endpoint
    jsPlumbInstance.addEndpoint(condId, {
      anchor: "Bottom",
      isSource: true,
      maxConnections: 1,
      cssClass: 'false-endpoint',
      parameters: {
        conditionPath: 'false'
      },
      connectorStyle: { stroke: "#dc2626", strokeWidth: 2 }, // Red for false
      connectorHoverStyle: { stroke: "#b91c1c", strokeWidth: 3 },
      endpoint: ["Dot", { radius: 5 }],
      paintStyle: { fill: "#dc2626", stroke: "#ffffff", strokeWidth: 2 },
      hoverPaintStyle: { fill: "#b91c1c", stroke: "#ffffff", strokeWidth: 2 },
      connectorOverlays: [
        ["Arrow", { location: 1, width: 12, length: 12, foldback: 0.8 }],
        ["Label", { 
          label: "False", 
          location: 0.5, 
          cssClass: "connection-label",
          labelStyle: { 
            color: "#dc2626",
            font: "12px sans-serif",
            padding: "2px 4px",
            backgroundColor: "#fef2f2",
            borderRadius: "3px"
          }
        }]
      ]
    });
    
    // Add event listeners
    conditional.addEventListener('dblclick', function() {
      editCondition(condId);
    });
    
    // Add to workflow data
    currentWorkflow[condId] = {
      type: 'conditional',
      condition: '',
      position: { left, top }
    };
  }
  
  // Function to delete a step
  function deleteStep(stepId) {
    if (confirm('Are you sure you want to delete this step?')) {
      // Remove connections
      jsPlumbInstance.remove(stepId);
      
      // Remove from workflow data
      delete currentWorkflow[stepId];
    }
  }
  
  // Function to edit condition
  function editCondition(condId) {
    currentStepId = condId;
    const condition = currentWorkflow[condId].condition || '';
    conditionExpression.value = condition;
    
    // Show dialog
    conditionDialog.style.display = 'flex';
  }
  
  // Function to edit step parameters
  function editStepParameters(stepId) {
    currentStepId = stepId;
    const parameters = currentWorkflow[stepId].parameters || {};
    stepParameters.value = JSON.stringify(parameters, null, 2);
    
    // Show dialog
    stepDialog.style.display = 'flex';
  }
  
  // Function to load existing workflow
  function loadWorkflow(workflowData) {
    // Clear canvas first
    clearCanvas();
    
    // Create all nodes first
    for (const [stepId, stepData] of Object.entries(workflowData)) {
      if (stepData.type === 'action') {
        addActionToCanvas({
          type: 'action',
          id: stepData.actionId,
          name: stepData.actionName,
          actionType: stepData.actionType
        }, stepData.position.left, stepData.position.top);
      } else if (stepData.type === 'start') {
        addStartNodeToCanvas(stepData.position.left, stepData.position.top);
      } else if (stepData.type === 'end') {
        addEndNodeToCanvas(stepData.position.left, stepData.position.top);
      } else if (stepData.type === 'conditional') {
        addConditionalToCanvas(stepData.position.left, stepData.position.top);
      }
    }
    
    // Then create connections
    for (const [stepId, stepData] of Object.entries(workflowData)) {
      if (stepData.connections) {
        for (const conn of stepData.connections) {
          // Find source and target endpoints
          const sourceEndpoints = jsPlumbInstance.getEndpoints(stepId);
          const targetEndpoints = jsPlumbInstance.getEndpoints(conn.target);
          
          if (sourceEndpoints && targetEndpoints) {
            let sourceEp, targetEp;
            
            if (stepData.type === 'conditional') {
              // For conditionals, find the correct source endpoint based on the condition path
              sourceEp = sourceEndpoints.find(ep => {
                return ep.parameters && ep.parameters.conditionPath === conn.conditionPath;
              });
            } else {
              // For normal steps, use the bottom endpoint as source
              sourceEp = sourceEndpoints.find(ep => ep.isSource);
            }
            
            // For all target steps, use the top endpoint
            targetEp = targetEndpoints.find(ep => ep.isTarget);
            
            if (sourceEp && targetEp) {
              jsPlumbInstance.connect({
                source: sourceEp,
                target: targetEp
              });
            }
          }
        }
      }
    }
  }
  
  // Function to clear canvas
  function clearCanvas() {
    if (confirm('Are you sure you want to clear the canvas? All workflow steps will be lost.')) {
      jsPlumbInstance.empty(workflowCanvas);
      currentWorkflow = {};
    }
  }
  
  // Function to save workflow
  function saveWorkflow() {
    // Get workflow name and description
    const workflowName = document.getElementById('workflowName').value;
    const workflowDescription = document.getElementById('workflowDescription').value;
    
    if (!workflowName) {
      alert('Please enter a workflow name');
      return;
    }
    
    // Update positions in workflow data
    for (const stepId in currentWorkflow) {
      const element = document.getElementById(stepId);
      if (element) {
        currentWorkflow[stepId].position = {
          left: parseInt(element.style.left),
          top: parseInt(element.style.top)
        };
      }
    }
    
    // Clear existing connections from workflow data
    for (const nodeId in currentWorkflow) {
      if (currentWorkflow[nodeId].connections) {
        delete currentWorkflow[nodeId].connections;
      }
    }
    
    // Add connection information
    jsPlumbInstance.getAllConnections().forEach(conn => {
      const sourceId = conn.source.id;
      const targetId = conn.target.id;
      
      if (!currentWorkflow[sourceId].connections) {
        currentWorkflow[sourceId].connections = [];
      }
      
      // Check if this is a conditional connection
      let conditionPath = null;
      if (currentWorkflow[sourceId].type === 'conditional') {
        // Get the condition path from the source endpoint
        conditionPath = conn.endpoints[0].parameters.conditionPath;
      }
      
      // Add connection to workflow data
      currentWorkflow[sourceId].connections.push({
        target: targetId,
        conditionPath: conditionPath
      });
    });
    
    // Serialize the workflow data
    const workflowDataString = JSON.stringify(currentWorkflow);
    
    // Try to use form submission as a fallback
    const hiddenForm = document.getElementById('workflowForm');
    const saveUrl = document.getElementById('saveUrl').value;
    
    // Fill hidden form fields
    document.getElementById('hiddenWorkflowName').value = workflowName;
    document.getElementById('hiddenWorkflowDescription').value = workflowDescription;
    document.getElementById('hiddenWorkflowData').value = workflowDataString;
    
    // Set form action
    hiddenForm.action = saveUrl;
    
    // Submit the form
    hiddenForm.submit();
    
    // Show loading message
    alert('Saving workflow... Please wait.');
    
    // Prevent default form submission
    return false;
  }
  
  // Event listeners
  clearCanvasBtn.addEventListener('click', clearCanvas);
  saveWorkflowBtn.addEventListener('click', saveWorkflow);
  
  // Condition dialog events
  document.querySelectorAll('.condition-dialog-close').forEach(btn => {
    btn.addEventListener('click', function() {
      conditionDialog.style.display = 'none';
    });
  });
  
  saveConditionBtn.addEventListener('click', function() {
    if (currentStepId) {
      currentWorkflow[currentStepId].condition = conditionExpression.value;
      conditionDialog.style.display = 'none';
    }
  });
  
  // Step dialog events
  document.querySelectorAll('.step-dialog-close').forEach(btn => {
    btn.addEventListener('click', function() {
      stepDialog.style.display = 'none';
    });
  });
  
  saveStepBtn.addEventListener('click', function() {
    if (currentStepId) {
      try {
        const params = JSON.parse(stepParameters.value);
        currentWorkflow[currentStepId].parameters = params;
        stepDialog.style.display = 'none';
      } catch (e) {
        alert('Invalid JSON. Please check your parameters.');
      }
    }
  });
  
  // Prevent closing dialogs when clicking inside
  conditionDialog.querySelector('.condition-dialog-content').addEventListener('click', function(e) {
    e.stopPropagation();
  });
  
  stepDialog.querySelector('.condition-dialog-content').addEventListener('click', function(e) {
    e.stopPropagation();
  });
  
  // Close dialogs when clicking outside
  conditionDialog.addEventListener('click', function() {
    conditionDialog.style.display = 'none';
  });
  
  stepDialog.addEventListener('click', function() {
    stepDialog.style.display = 'none';
  });
  
  // Initialize jsPlumb defaults and make endpoints always visible
  jsPlumbInstance.importDefaults({
    PaintStyle: {
      stroke: "#6b7280",
      strokeWidth: 2
    },
    Endpoints: [
      [ "Dot", { radius: 4 } ],
      [ "Dot", { radius: 4 } ]
    ],
    Connector: [ "Flowchart", { cornerRadius: 5 } ],
    EndpointStyle: { 
      fill: "#6b7280", 
      stroke: "#ffffff",
      strokeWidth: 2,
      radius: 5
    }
  });
  
  // Make all endpoints visible, even when not dragging a connection
  jsPlumbInstance.bind("ready", function() {
    // Show all endpoints
    jsPlumbInstance.setZoom(1.0);  // Ensure proper scaling
    
    // Make existing endpoints more visible
    setTimeout(function() {
      const endpoints = document.querySelectorAll(".endpoint");
      endpoints.forEach(endpoint => {
        endpoint.style.visibility = "visible";
        endpoint.style.opacity = "1";
      });
    }, 500);
  });
});
</script>
{% endblock %}